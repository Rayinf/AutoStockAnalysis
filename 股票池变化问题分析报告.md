# 股票池自动变化问题分析报告

## 🔍 问题现象
用户反映自选股票池经常自己变化，即使数据应该存储在数据库中。

## 📊 技术调查结果

### 1. 存储机制分析
经过代码分析发现，**股票池数据实际上存储在JSON文件中，而不是数据库中**：

```python
# 配置文件路径
STOCK_POOLS_CONFIG_FILE = "stock_pools_config.json"

def load_stock_pools():
    """加载股票池配置"""
    try:
        if os.path.exists(STOCK_POOLS_CONFIG_FILE):
            with open(STOCK_POOLS_CONFIG_FILE, 'r', encoding='utf-8') as f:
                return _json.load(f)
    except Exception as e:
        print(f"加载股票池配置失败: {e}")
    
    # 返回默认配置 - 这是问题的根源！
    return {
        "蓝筹股": {...},
        "银行股": {...},
        # ... 默认股票池
    }
```

### 2. 潜在问题原因

#### 🚨 **主要风险点**：
1. **文件读取失败回退机制**：如果JSON文件读取失败，系统会返回硬编码的默认配置
2. **文件权限问题**：如果文件权限不当，可能导致读写失败
3. **JSON解析错误**：如果文件损坏或格式错误，会触发默认配置
4. **并发写入冲突**：多个请求同时修改可能导致数据丢失
5. **系统重启或崩溃**：可能导致未保存的更改丢失

#### 📁 **文件系统风险**：
- 文件可能被意外删除或移动
- 磁盘空间不足导致写入失败
- 文件系统错误或损坏
- 权限变化导致无法访问

## 🔧 当前配置状态检查

### 文件状态：
- ✅ 配置文件存在：`stock_pools_config.json`
- ✅ 文件大小：1266 bytes
- ✅ JSON格式正确
- ✅ 包含6个股票池：蓝筹股、银行股、科技股、全市场、我的自选、京爷股票池
- ✅ "我的自选"包含9只股票

### API状态：
- ✅ GET `/api/strategy/stock_pools` 正常返回
- ✅ 数据与文件内容一致

## 🛠️ 解决方案

### 1. **立即改进措施**

#### A. 增强错误处理和日志
```python
def load_stock_pools():
    """加载股票池配置（增强版）"""
    import logging
    
    try:
        if os.path.exists(STOCK_POOLS_CONFIG_FILE):
            with open(STOCK_POOLS_CONFIG_FILE, 'r', encoding='utf-8') as f:
                data = _json.load(f)
                logging.info(f"成功加载股票池配置，包含{len(data)}个股票池")
                return data
        else:
            logging.warning(f"股票池配置文件不存在: {STOCK_POOLS_CONFIG_FILE}")
    except json.JSONDecodeError as e:
        logging.error(f"JSON解析错误: {e}")
    except PermissionError as e:
        logging.error(f"文件权限错误: {e}")
    except Exception as e:
        logging.error(f"加载股票池配置失败: {e}")
    
    # 只有在真正失败时才返回默认配置，并记录警告
    logging.warning("使用默认股票池配置")
    return get_default_stock_pools()
```

#### B. 文件备份机制
```python
def save_stock_pools(pools):
    """保存股票池配置（带备份）"""
    import shutil
    
    try:
        # 创建备份
        if os.path.exists(STOCK_POOLS_CONFIG_FILE):
            backup_file = f"{STOCK_POOLS_CONFIG_FILE}.backup"
            shutil.copy2(STOCK_POOLS_CONFIG_FILE, backup_file)
        
        # 原子写入
        temp_file = f"{STOCK_POOLS_CONFIG_FILE}.tmp"
        with open(temp_file, 'w', encoding='utf-8') as f:
            _json.dump(pools, f, ensure_ascii=False, indent=2)
        
        # 原子替换
        os.replace(temp_file, STOCK_POOLS_CONFIG_FILE)
        return True
    except Exception as e:
        logging.error(f"保存股票池配置失败: {e}")
        return False
```

### 2. **长期解决方案：迁移到数据库**

#### A. 数据库表设计
```sql
-- 股票池表
CREATE TABLE stock_pools (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(50) UNIQUE NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 股票池股票关联表
CREATE TABLE stock_pool_stocks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    pool_id INTEGER NOT NULL,
    stock_symbol VARCHAR(10) NOT NULL,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (pool_id) REFERENCES stock_pools(id),
    UNIQUE(pool_id, stock_symbol)
);
```

#### B. 数据库操作接口
```python
class StockPoolManager:
    def __init__(self, db_connection):
        self.db = db_connection
    
    def get_all_pools(self):
        """获取所有股票池"""
        # 数据库查询逻辑
        pass
    
    def save_pool(self, name, stocks, description=""):
        """保存股票池"""
        # 事务性保存
        pass
    
    def update_pool(self, name, stocks):
        """更新股票池"""
        # 原子性更新
        pass
```

### 3. **监控和诊断工具**

已创建监控脚本 `stock_pool_monitor.py`，可以：
- 实时监控配置文件变化
- 记录详细的变化日志
- 检测文件哈希变化
- 对比股票池内容差异

## 📋 建议的行动计划

### 立即执行（今天）：
1. ✅ 部署监控脚本，开始记录变化
2. 🔄 增强错误处理和日志记录
3. 🔄 实施文件备份机制

### 短期计划（1周内）：
1. 🔄 迁移到SQLite数据库存储
2. 🔄 实现数据库事务性操作
3. 🔄 添加配置文件自动恢复机制

### 长期优化（1个月内）：
1. 🔄 实现配置版本控制
2. 🔄 添加用户操作审计日志
3. 🔄 实现自动数据完整性检查

## 🚨 紧急处理步骤

如果股票池再次丢失：

1. **检查备份文件**：
   ```bash
   ls -la stock_pools_config.json*
   ```

2. **恢复备份**：
   ```bash
   cp stock_pools_config.json.backup stock_pools_config.json
   ```

3. **检查权限**：
   ```bash
   chmod 644 stock_pools_config.json
   ```

4. **启动监控**：
   ```bash
   python3 stock_pool_monitor.py
   ```

## 📞 用户建议

1. **定期备份**：手动复制您的自选股票列表
2. **避免并发操作**：不要在多个窗口同时编辑股票池
3. **及时保存**：修改后立即点击保存按钮
4. **监控日志**：如果问题再次发生，查看 `stock_pool_changes.log` 文件

## 🔍 根本原因总结

**股票池变化的根本原因是使用了文件存储而非数据库存储**，这导致了以下问题：
- 缺乏事务性保证
- 容易受到文件系统问题影响
- 错误处理机制会重置为默认配置
- 缺乏变化追踪和审计

**推荐的最终解决方案是迁移到数据库存储，这将提供更好的数据完整性、并发控制和错误恢复能力。**
